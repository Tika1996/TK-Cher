<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIKatcher</title>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #2b2d42;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 20px;
        }

        .app-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .app-header h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .app-header p {
            color: #666;
            font-size: 1.1rem;
        }

        .workflow-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--card-background);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .drop-zone {
            border: 2px dashed var(--accent-color);
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(67, 97, 238, 0.05);
        }

        .drop-zone:hover, .drop-zone.drag-over {
            background: rgba(67, 97, 238, 0.1);
            border-color: var(--primary-color);
        }

        .drop-zone i {
            font-size: 2rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
        }

        .matching-config {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .column-pair {
            background: rgba(67, 97, 238, 0.05);
            padding: 1rem;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        select {
            padding: 0.8rem;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: white;
            flex: 1;
            font-size: 0.9rem;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .progress-section {
            background: var(--card-background);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
        }

        .progress-bar {
            height: 10px;
            background: #eee;
            border-radius: 5px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress {
            height: 100%;
            background: var(--success-color);
            transition: width 0.3s ease;
        }

        .control-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .fuzzy-matching {
            background: rgba(67, 97, 238, 0.05);
            padding: 1rem;
            border-radius: var(--border-radius);
        }

        .threshold-slider {
            margin-top: 1rem;
        }

        input[type="range"] {
            width: 100%;
            margin: 0.5rem 0;
        }

        .result-columns {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .result-column-item {
            background: rgba(67, 97, 238, 0.05);
            padding: 0.8rem;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        @media (max-width: 768px) {
            .workflow-container {
                grid-template-columns: 1fr;
            }

            .column-pair {
                flex-direction: column;
            }
        }

        .progress-text {
            text-align: center;
            margin-top: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .file-info {
            display: none;
            background: var(--card-background);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-top: 0.5rem;
            box-shadow: var(--box-shadow);
        }

        .file-info.visible {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .file-info i {
            color: var(--primary-color);
            font-size: 1.5rem;
        }

        .file-info .file-details {
            flex: 1;
        }

        .file-info .file-name {
            font-weight: 500;
            margin-bottom: 0.2rem;
        }

        .file-info .remove-file {
            color: var(--danger-color);
            cursor: pointer;
            padding: 0.5rem;
            border: none;
            background: none;
            font-size: 1.2rem;
        }

        .file-info .remove-file:hover {
            opacity: 0.8;
        }

        .timer-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .timer-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-color);
        }

        .timer-item i {
            color: var(--primary-color);
        }

        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-container {
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .login-container h2 {
            margin-bottom: 2rem;
            color: var(--primary-color);
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
        }

        .password-input {
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }

        .login-error {
            color: var(--danger-color);
            font-size: 0.9rem;
            min-height: 1.2em;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <div id="loginOverlay" class="login-overlay">
        <div class="login-container card">
            <h2>
                <i class="fas fa-lock"></i>
                Accès sécurisé
            </h2>
            <div class="login-form">
                <input type="password" id="passwordInput" placeholder="Entrez le mot de passe" class="password-input">
                <button id="loginButton" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i>
                    Connexion
                </button>
                <p id="loginError" class="login-error"></p>
            </div>
        </div>
    </div>

    <div class="container">
        <header class="app-header">
            <h1>Excel Matcher Pro</h1>
            <p>Comparez et fusionnez vos fichiers Excel en toute simplicité</p>
        </header>

        <div class="workflow-container">
            <!-- Section des fichiers -->
            <div class="card">
                <h2>
                    <i class="fas fa-file-excel"></i>
                    Fichiers source
                </h2>
                <div class="file-upload-container">
                    <input type="file" id="referenceFile" accept=".xlsx, .xls" style="display: none;">
                    <div class="drop-zone" id="referenceDropZone">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Fichier de référence</p>
                        <small>Glissez ou cliquez pour charger</small>
                    </div>
                    <div class="file-info" id="referenceFileInfo">
                        <i class="fas fa-file-excel"></i>
                        <div class="file-details">
                            <div class="file-name"></div>
                        </div>
                        <button class="remove-file" title="Supprimer">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <input type="file" id="targetFile" accept=".xlsx, .xls" style="display: none;">
                    <div class="drop-zone" id="targetDropZone" style="margin-top: 1rem;">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Fichier cible</p>
                        <small>Glissez ou cliquez pour charger</small>
                    </div>
                    <div class="file-info" id="targetFileInfo">
                        <i class="fas fa-file-excel"></i>
                        <div class="file-details">
                            <div class="file-name"></div>
                        </div>
                        <button class="remove-file" title="Supprimer">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Section de configuration -->
            <div class="card" id="matchingConfig" style="display: none;">
                <h2>
                    <i class="fas fa-cog"></i>
                    Configuration
                </h2>
                <div class="matching-config">
                    <div id="matchingColumns">
                        <button class="btn btn-primary" id="addColumnBtn">
                            <i class="fas fa-plus"></i>
                            Ajouter une colonne
                        </button>
                    </div>

                    <div class="fuzzy-matching">
                        <label class="switch">
                            <input type="checkbox" id="fuzzyToggle">
                            <span class="slider"></span>
                            Matching approximatif
                        </label>
                        <div class="threshold-slider" id="thresholdContainer" style="display: none;">
                            <label>Seuil de similarité: <span id="thresholdValue">85</span>%</label>
                            <input type="range" id="threshold" min="50" max="100" value="85">
                        </div>
                    </div>

                    <div class="result-columns" id="resultColumns"></div>
                </div>
            </div>
        </div>

        <!-- Section de traitement -->
        <div class="progress-section" id="processing" style="display: none;">
            <div class="timer-container">
                <div class="timer-item">
                    <i class="fas fa-clock"></i>
                    <span>Temps écoulé: <span id="timer">00:00</span></span>
                </div>
                <div class="timer-item">
                    <i class="fas fa-hourglass-half"></i>
                    <span>Temps restant: <span id="remainingTime">--:--</span></span>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">0%</div>
            <div class="control-buttons">
                <button id="startBtn" class="btn btn-primary">
                    <i class="fas fa-play"></i>
                    Démarrer
                </button>
                <button id="pauseBtn" class="btn btn-secondary" disabled>
                    <i class="fas fa-pause"></i>
                    Pause
                </button>
                <button id="stopBtn" class="btn btn-danger" disabled>
                    <i class="fas fa-stop"></i>
                    Arrêter
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        class LoginManager {
            constructor(onLoginSuccess) {
                this.correctHash = 'c35933ee6cc7ca251c9fe156be5851e87a061fb6d1e0f2cb4bd66734c4cc89c0'; // mot de passe: admin
                this.onLoginSuccess = onLoginSuccess;
                this.loginOverlay = document.getElementById('loginOverlay');
                this.passwordInput = document.getElementById('passwordInput');
                this.loginButton = document.getElementById('loginButton');
                this.loginError = document.getElementById('loginError');
                
                this.setupEventListeners();
            }

            setupEventListeners() {
                this.loginButton.addEventListener('click', () => this.validatePassword());
                this.passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.validatePassword();
                    }
                });
            }

            validatePassword() {
                const password = this.passwordInput.value;
                const hashedPassword = CryptoJS.SHA256(password).toString();

                if (hashedPassword === this.correctHash) {
                    this.loginOverlay.style.display = 'none';
                    this.onLoginSuccess();
                } else {
                    this.loginError.textContent = 'Mot de passe incorrect';
                    this.passwordInput.value = '';
                }
            }
        }

        class ExcelMatcher {
            constructor() {
                this.referenceData = null;
                this.targetData = null;
                this.matchingColumns = [];
                this.resultColumns = new Set();
                this.isPaused = false;
                this.isStopped = false;
                this.startTime = 0;
                this.elapsedTime = 0;
                this.timerInterval = null;
                this.worker = null;
                
                this.container = document.querySelector('.container');
                
                this.initializeElements();
                this.setupEventListeners();
            }

            initializeElements() {
                this.referenceFileInput = document.getElementById('referenceFile');
                this.targetFileInput = document.getElementById('targetFile');
                this.referenceDropZone = document.getElementById('referenceDropZone');
                this.targetDropZone = document.getElementById('targetDropZone');
                this.matchingConfig = document.getElementById('matchingConfig');
                this.matchingColumnsContainer = document.getElementById('matchingColumns');
                this.addColumnBtn = document.getElementById('addColumnBtn');
                this.fuzzyToggle = document.getElementById('fuzzyToggle');
                this.thresholdContainer = document.getElementById('thresholdContainer');
                this.thresholdSlider = document.getElementById('threshold');
                this.thresholdValue = document.getElementById('thresholdValue');
                this.resultColumnsContainer = document.getElementById('resultColumns');
                this.processing = document.getElementById('processing');
                this.progressBar = document.getElementById('progressBar');
                this.progressText = document.getElementById('progressText');
                this.startBtn = document.getElementById('startBtn');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.timerElement = document.getElementById('timer');
                this.referenceFileInfo = document.getElementById('referenceFileInfo');
                this.targetFileInfo = document.getElementById('targetFileInfo');
                this.remainingTimeElement = document.getElementById('remainingTime');
            }

            setupEventListeners() {
                this.setupFileUpload(this.referenceFileInput, this.referenceDropZone, 'reference');
                this.setupFileUpload(this.targetFileInput, this.targetDropZone, 'target');
                this.addColumnBtn.addEventListener('click', () => this.addMatchingColumn());
                this.fuzzyToggle.addEventListener('change', () => {
                    this.thresholdContainer.style.display = this.fuzzyToggle.checked ? 'block' : 'none';
                });
                this.thresholdSlider.addEventListener('input', (e) => {
                    this.thresholdValue.textContent = e.target.value;
                });
                this.startBtn.addEventListener('click', () => this.startProcessing());
                this.pauseBtn.addEventListener('click', () => this.togglePause());
                this.stopBtn.addEventListener('click', () => this.stopProcessing());
            }

            setupFileUpload(input, dropZone, type) {
                dropZone.addEventListener('click', () => input.click());
                
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('drag-over');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                    const file = e.dataTransfer.files[0];
                    if (file) this.handleFileUpload(file, type);
                });
                
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) this.handleFileUpload(file, type);
                });
            }

            async handleFileUpload(file, type) {
                try {
                    const data = await this.readExcelFile(file);
                    if (type === 'reference') {
                        this.referenceData = data;
                        this.updateFileInfo(file, this.referenceFileInfo, this.referenceDropZone);
                        this.updateResultColumnsSelection();
                    } else {
                        this.targetData = data;
                        this.updateFileInfo(file, this.targetFileInfo, this.targetDropZone);
                    }
                    
                    if (this.referenceData && this.targetData) {
                        this.matchingConfig.style.display = 'block';
                        this.processing.style.display = 'block';
                        this.updateColumnSelections();
                    }
                } catch (error) {
                    console.error('Error reading file:', error);
                    alert('Error reading file. Please try again.');
                }
            }

            readExcelFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);
                            resolve(jsonData);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }

            addMatchingColumn() {
                const columnPair = document.createElement('div');
                columnPair.className = 'column-pair';
                
                const referenceSelect = this.createColumnSelect(this.referenceData, 'reference');
                const targetSelect = this.createColumnSelect(this.targetData, 'target');
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-column-btn';
                removeBtn.textContent = '×';
                removeBtn.onclick = () => {
                    columnPair.remove();
                    this.updateMatchingColumns();
                };

                columnPair.appendChild(referenceSelect);
                columnPair.appendChild(targetSelect);
                columnPair.appendChild(removeBtn);

                this.matchingColumnsContainer.insertBefore(columnPair, this.addColumnBtn);
                this.updateMatchingColumns();
            }

            createColumnSelect(data, type) {
                const select = document.createElement('select');
                select.className = type + '-column';
                const columns = data ? Object.keys(data[0]) : [];
                columns.forEach(column => {
                    const option = document.createElement('option');
                    option.value = column;
                    option.textContent = column;
                    select.appendChild(option);
                });
                select.addEventListener('change', () => this.updateMatchingColumns());
                return select;
            }

            updateColumnSelections() {
                const columns = this.matchingColumnsContainer.querySelectorAll('.column-pair');
                columns.forEach(column => column.remove());
                this.addMatchingColumn();
            }

            updateResultColumnsSelection() {
                this.resultColumnsContainer.innerHTML = '';
                if (!this.referenceData || !this.referenceData[0]) return;

                Object.keys(this.referenceData[0]).forEach(column => {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `result-${column}`;
                    checkbox.value = column;
                    checkbox.checked = this.resultColumns.has(column);
                    checkbox.onchange = () => {
                        if (checkbox.checked) {
                            this.resultColumns.add(column);
                        } else {
                            this.resultColumns.delete(column);
                        }
                    };

                    const label = document.createElement('label');
                    label.htmlFor = `result-${column}`;
                    label.textContent = column;

                    const div = document.createElement('div');
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    this.resultColumnsContainer.appendChild(div);
                });
            }

            updateMatchingColumns() {
                this.matchingColumns = [];
                const columnPairs = this.matchingColumnsContainer.querySelectorAll('.column-pair');
                columnPairs.forEach(pair => {
                    const referenceColumn = pair.querySelector('.reference-column').value;
                    const targetColumn = pair.querySelector('.target-column').value;
                    this.matchingColumns.push({ reference: referenceColumn, target: targetColumn });
                });
            }

            startProcessing() {
                if (!this.validateConfiguration()) return;

                this.isPaused = false;
                this.isStopped = false;
                this.startBtn.disabled = true;
                this.pauseBtn.disabled = false;
                this.stopBtn.disabled = false;

                this.progressBar.style.width = '0%';
                this.progressText.textContent = '0%';
                this.remainingTimeElement.textContent = '--:--';
                
                this.startTime = Date.now();
                this.elapsedTime = 0;
                this.updateTimer();
                this.timerInterval = setInterval(() => this.updateTimer(), 1000);

                this.initializeWorker();
            }

            validateConfiguration() {
                if (!this.referenceData || !this.targetData) {
                    alert('Please upload both files first.');
                    return false;
                }

                if (this.matchingColumns.length === 0) {
                    alert('Please add at least one matching column.');
                    return false;
                }

                if (this.resultColumns.size === 0) {
                    alert('Please select at least one result column.');
                    return false;
                }

                return true;
            }

            initializeWorker() {
                if (this.worker) {
                    this.worker.terminate();
                }

                const workerScript = `
                    importScripts('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');

                    let isPaused = false;
                    let isStopped = false;

                    self.onmessage = function(e) {
                        const { type, data } = e.data;
                        switch (type) {
                            case 'start':
                                processData(data);
                                break;
                            case 'pause':
                                isPaused = true;
                                break;
                            case 'resume':
                                isPaused = false;
                                break;
                            case 'stop':
                                isStopped = true;
                                break;
                        }
                    };

                    async function processData(data) {
                        const { referenceData, targetData, matchingColumns, resultColumns, fuzzyEnabled, threshold } = data;
                        
                        const referenceIndex = createIndex(referenceData, matchingColumns.map(col => col.reference));
                        const totalRows = targetData.length;
                        let processedRows = 0;

                        // Traiter par petits lots
                        const batchSize = 5;
                        
                        for (let i = 0; i < totalRows; i += batchSize) {
                            if (isStopped) break;
                            
                            while (isPaused) {
                                if (isStopped) break;
                                await new Promise(resolve => setTimeout(resolve, 100));
                            }

                            const batchEnd = Math.min(i + batchSize, totalRows);
                            const batch = targetData.slice(i, batchEnd);
                            
                            // Traiter le lot
                            for (const row of batch) {
                                const match = findBestMatch(row, referenceIndex, matchingColumns, fuzzyEnabled, threshold);
                                if (match) {
                                    resultColumns.forEach(column => {
                                        row[column + '_matched'] = match.row[column];
                                    });
                                    const matchedValues = matchingColumns.map(({ reference }) => 
                                        match.row[reference]
                                    ).join(' | ');
                                    row['matched_from'] = matchedValues;
                                    if (fuzzyEnabled) {
                                        row.similarity = (match.similarity * 100).toFixed(2) + '%';
                                    }
                                } else {
                                    row['matched_from'] = 'Aucune correspondance trouvée';
                                }
                            }

                            processedRows += batch.length;
                            
                            // Envoyer la progression
                            const progress = (processedRows / totalRows) * 100;
                            self.postMessage({
                                type: 'progress',
                                data: {
                                    progress,
                                    processedRows,
                                    totalRows
                                }
                            });

                            // Petit délai pour éviter de bloquer le thread
                            await new Promise(resolve => setTimeout(resolve, 1));
                        }

                        self.postMessage({ type: 'result', data: targetData });
                    }

                    function createIndex(data, columns) {
                        const index = new Map();
                        for (const row of data) {
                            const key = columns.map(col => normalizeText(row[col])).join('|');
                            if (!index.has(key)) {
                                index.set(key, []);
                            }
                            index.get(key).push(row);
                        }
                        return index;
                    }

                    function findBestMatch(targetRow, referenceIndex, matchingColumns, fuzzyEnabled, threshold) {
                        const targetKey = matchingColumns.map(({ target }) => normalizeText(targetRow[target])).join('|');
                        
                        if (!fuzzyEnabled) {
                            const exactMatches = referenceIndex.get(targetKey);
                            return exactMatches && exactMatches.length > 0 ? { row: exactMatches[0], similarity: 1 } : null;
                        }

                        let bestMatch = null;
                        let bestSimilarity = 0;

                        for (const [key, rows] of referenceIndex.entries()) {
                            const similarity = calculateSimilarity(targetKey, key);
                            if (similarity >= threshold && similarity > bestSimilarity) {
                                bestSimilarity = similarity;
                                bestMatch = { row: rows[0], similarity };
                            }
                        }

                        return bestMatch;
                    }

                    function calculateSimilarity(str1, str2) {
                        const longer = str1.length > str2.length ? str1 : str2;
                        const shorter = str1.length > str2.length ? str2 : str1;
                        const longerLength = longer.length;
                        if (longerLength === 0) {
                            return 1.0;
                        }
                        return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
                    }

                    function editDistance(s1, s2) {
                        s1 = s1.toLowerCase();
                        s2 = s2.toLowerCase();

                        const costs = new Array();
                        for (let i = 0; i <= s1.length; i++) {
                            let lastValue = i;
                            for (let j = 0; j <= s2.length; j++) {
                                if (i == 0)
                                    costs[j] = j;
                                else {
                                    if (j > 0) {
                                        let newValue = costs[j - 1];
                                        if (s1.charAt(i - 1) != s2.charAt(j - 1))
                                            newValue = Math.min(Math.min(newValue, lastValue),
                                                costs[j]) + 1;
                                        costs[j - 1] = lastValue;
                                        lastValue = newValue;
                                    }
                                }
                            }
                            if (i > 0)
                                costs[s2.length] = lastValue;
                        }
                        return costs[s2.length];
                    }

                    function normalizeText(text) {
                        if (!text) return '';
                        return String(text).toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');
                    }
                `;

                const blob = new Blob([workerScript], { type: 'application/javascript' });
                const workerUrl = URL.createObjectURL(blob);

                this.worker = new Worker(workerUrl);

                this.worker.onmessage = (e) => {
                    const { type, data } = e.data;
                    switch (type) {
                        case 'progress':
                            requestAnimationFrame(() => this.updateProgress(data));
                            break;
                        case 'result':
                            this.targetData = data;
                            this.finishProcessing();
                            break;
                    }
                };

                const workerData = {
                    referenceData: this.referenceData,
                    targetData: this.targetData,
                    matchingColumns: this.matchingColumns,
                    resultColumns: Array.from(this.resultColumns),
                    fuzzyEnabled: this.fuzzyToggle.checked,
                    threshold: this.thresholdSlider.value / 100
                };

                this.worker.postMessage({ type: 'start', data: workerData });
            }

            togglePause() {
                this.isPaused = !this.isPaused;
                this.pauseBtn.textContent = this.isPaused ? 'Reprendre' : 'Pause';
                this.worker.postMessage({ type: this.isPaused ? 'pause' : 'resume' });
            }

            stopProcessing() {
                this.isStopped = true;
                this.resetControls();
                clearInterval(this.timerInterval);
                if (this.worker) {
                    this.worker.terminate();
                    this.worker = null;
                }
            }

            updateProgress(data) {
                const { progress, processedRows, totalRows } = data;
                const roundedProgress = Math.round(progress);
                
                requestAnimationFrame(() => {
                    this.progressBar.style.width = `${roundedProgress}%`;
                    this.progressText.textContent = `${roundedProgress}% (${processedRows}/${totalRows} lignes)`;

                    const currentTime = Date.now();
                    const elapsedSeconds = (currentTime - this.startTime) / 1000;
                    
                    if (processedRows > 0 && elapsedSeconds > 0) {
                        const rowsPerSecond = processedRows / elapsedSeconds;
                        if (rowsPerSecond > 0) {
                            const remainingRows = totalRows - processedRows;
                            const remainingSeconds = Math.max(0, Math.round(remainingRows / rowsPerSecond));
                            
                            const remainingMinutes = Math.floor(remainingSeconds / 60);
                            const remainingSecs = remainingSeconds % 60;
                            this.remainingTimeElement.textContent = 
                                `${remainingMinutes.toString().padStart(2, '0')}:${remainingSecs.toString().padStart(2, '0')}`;
                        }
                    }
                });
            }

            resetControls() {
                this.startBtn.disabled = false;
                this.pauseBtn.disabled = true;
                this.stopBtn.disabled = true;
                this.pauseBtn.textContent = 'Pause';
            }

            updateTimer() {
                const currentTime = Date.now();
                this.elapsedTime = Math.floor((currentTime - this.startTime) / 1000);
                const minutes = Math.floor(this.elapsedTime / 60);
                const seconds = this.elapsedTime % 60;
                this.timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            finishProcessing() {
                this.resetControls();
                this.updateProgress(100);
                clearInterval(this.timerInterval);
                this.remainingTimeElement.textContent = '00:00';
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(this.targetData);
                XLSX.utils.book_append_sheet(wb, ws, 'Matched Results');
                XLSX.writeFile(wb, 'matched_results.xlsx');
            }

            updateFileInfo(file, fileInfoElement, dropZone) {
                const fileNameElement = fileInfoElement.querySelector('.file-name');
                fileNameElement.textContent = file.name;
                
                fileInfoElement.classList.add('visible');
                dropZone.style.display = 'none';
                
                const removeButton = fileInfoElement.querySelector('.remove-file');
                removeButton.onclick = () => this.removeFile(fileInfoElement, dropZone);
            }

            removeFile(fileInfoElement, dropZone) {
                fileInfoElement.classList.remove('visible');
                dropZone.style.display = 'block';
                
                if (fileInfoElement === this.referenceFileInfo) {
                    this.referenceData = null;
                    this.referenceFileInput.value = '';
                } else {
                    this.targetData = null;
                    this.targetFileInput.value = '';
                }
                
                if (!this.referenceData || !this.targetData) {
                    this.matchingConfig.style.display = 'none';
                    this.processing.style.display = 'none';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const app = new ExcelMatcher();
            app.container.style.display = 'none'; // Cacher l'application initialement
            
            new LoginManager(() => {
                app.container.style.display = 'block'; // Afficher l'application après connexion réussie
            });
        });
    </script>
</body>
</html>

